'use client'

import { useEffect } from 'react'
import { onCLS, onFCP, onLCP, onTTFB, onINP, type Metric } from 'web-vitals'


interface WebVitalsData {
  name: string
  value: number
  rating: 'good' | 'needs-improvement' | 'poor'
  id: string
  navigationType: string
  delta: number
}

// Web Vitals ÏûÑÍ≥ÑÍ∞í Ï†ïÏùò (Google Í∂åÏû• Í∏∞Ï§Ä)
const VITALS_THRESHOLDS = {
  LCP: { good: 2500, poor: 4000 }, // Largest Contentful Paint
  // FIDÎäî web-vitals v5ÏóêÏÑú Ï†úÍ±∞ÎêòÏñ¥ INPÎ°ú ÎåÄÏ≤¥Îê®
  CLS: { good: 0.1, poor: 0.25 }, // Cumulative Layout Shift
  FCP: { good: 1800, poor: 3000 }, // First Contentful Paint
  TTFB: { good: 800, poor: 1800 }, // Time to First Byte
  INP: { good: 200, poor: 500 }, // Interaction to Next Paint
}

// Îì±Í∏â Í≥ÑÏÇ∞ Ìï®Ïàò
function calculateRating(name: string, value: number): 'good' | 'needs-improvement' | 'poor' {
  const thresholds = VITALS_THRESHOLDS[name as keyof typeof VITALS_THRESHOLDS]
  if (!thresholds) return 'good'

  if (value <= thresholds.good) return 'good'
  if (value <= thresholds.poor) return 'needs-improvement'
  return 'poor'
}

// ÏÑ±Îä• Îç∞Ïù¥ÌÑ∞Î•º ÏΩòÏÜîÏóê Î°úÍ∑∏
function logPerformanceData(metric: Metric) {
  const webVitalsData: WebVitalsData = {
    name: metric.name,
    value: metric.value,
    rating: calculateRating(metric.name, metric.value),
    id: metric.id,
    navigationType: metric.navigationType || 'unknown',
    delta: metric.delta,
  }

  // ÏΩòÏÜîÏóê ÏÑ±Îä• Î©îÌä∏Î¶≠ Î°úÍ∑∏
  console.info(`üìä Performance [${metric.name}]:`, webVitalsData)

  // ÏÑ±Îä• ÏûÑÍ≥ÑÍ∞í Ï¥àÍ≥ºÏãú Í≤ΩÍ≥† Î°úÍ∑∏
  if (webVitalsData.rating === 'poor') {
    console.warn(`‚ö†Ô∏è Poor Web Vital: ${metric.name}`, webVitalsData)
  }
}

// Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏÑ±Îä• Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (ÎîîÎ≤ÑÍπÖÏö©)
function saveToLocalStorage(metric: Metric) {
  if (typeof window === 'undefined') return

  try {
    const webVitalsData: WebVitalsData = {
      name: metric.name,
      value: metric.value,
      rating: calculateRating(metric.name, metric.value),
      id: metric.id,
      navigationType: metric.navigationType || 'unknown',
      delta: metric.delta,
    }

    const existing = JSON.parse(localStorage.getItem('web-vitals') || '[]')
    const updated = [
      ...existing.filter((item: WebVitalsData) => item.name !== metric.name),
      { ...webVitalsData, timestamp: Date.now() },
    ]

    // ÏµúÎåÄ 50Í∞ú Ìï≠Î™©Îßå Ïú†ÏßÄ
    const limited = updated.slice(-50)
    localStorage.setItem('web-vitals', JSON.stringify(limited))
  } catch (error) {
    console.warn('Failed to save Web Vitals to localStorage:', error)
  }
}

// Google AnalyticsÎ°ú Ï†ÑÏÜ° (ÏÑ†ÌÉùÏÇ¨Ìï≠)
function sendToAnalytics(metric: Metric) {
  // @ts-expect-error - gtag is loaded by Google Analytics
  if (typeof window !== 'undefined' && window.gtag) {
    // @ts-expect-error - gtag is loaded by Google Analytics
    window.gtag('event', metric.name, {
      event_category: 'Web Vitals',
      value: Math.round(metric.name === 'CLS' ? metric.value * 1000 : metric.value),
      event_label: metric.id,
      non_interaction: true,
    })
  }
}

// ÌÜµÌï© Î¶¨Ìè¨ÌåÖ Ìï®Ïàò
function reportWebVital(metric: Metric) {
  console.info(`üìä Web Vital [${metric.name}]:`, {
    value: `${metric.value}${metric.name === 'CLS' ? '' : 'ms'}`,
    rating: calculateRating(metric.name, metric.value),
    id: metric.id,
    navigationType: metric.navigationType,
    delta: metric.delta,
  })

  // Îã§ÏñëÌïú Î™©Ï†ÅÏßÄÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
  logPerformanceData(metric)
  saveToLocalStorage(metric)
  sendToAnalytics(metric)
}

// Web Vitals ÏÑ±Îä• ÏöîÏïΩ ÌëúÏãú (Í∞úÎ∞ú Î™®Îìú)
function showPerformanceSummary() {
  if (process.env.NODE_ENV !== 'development') return

  setTimeout(() => {
    const vitals = JSON.parse(localStorage.getItem('web-vitals') || '[]')
    if (vitals.length > 0) {
      console.group('üìä Web Vitals Summary')
      vitals.forEach((vital: WebVitalsData & { timestamp: number }) => {
        const emoji =
          vital.rating === 'good' ? '‚úÖ' : vital.rating === 'needs-improvement' ? '‚ö†Ô∏è' : '‚ùå'
        console.log(
          `${emoji} ${vital.name}: ${vital.value}${vital.name === 'CLS' ? '' : 'ms'} (${vital.rating})`
        )
      })
      console.groupEnd()
    }
  }, 3000) // 3Ï¥à ÌõÑ ÏöîÏïΩ ÌëúÏãú
}

export function WebVitalsReporter() {
  useEffect(() => {
    // Web Vitals Î©îÌä∏Î¶≠ Íµ¨ÎèÖ
    onCLS(reportWebVital) // ÎàÑÏ†Å Î†àÏù¥ÏïÑÏõÉ Ïù¥Îèô
    onFCP(reportWebVital) // Ï≤´ ÏΩòÌÖêÏ∏†ÌíÄ ÌéòÏù∏Ìä∏
    // onFIDÎäî web-vitals v5ÏóêÏÑú Ï†úÍ±∞ÎêòÏñ¥ INPÎ°ú ÎåÄÏ≤¥Îê®
    onLCP(reportWebVital) // ÏµúÎåÄ ÏΩòÌÖêÏ∏†ÌíÄ ÌéòÏù∏Ìä∏
    onTTFB(reportWebVital) // Ï≤´ Î∞îÏù¥Ìä∏ÍπåÏßÄÏùò ÏãúÍ∞Ñ
    onINP(reportWebVital) // Îã§Ïùå ÌéòÏù∏Ìä∏ÍπåÏßÄÏùò ÏÉÅÌò∏ÏûëÏö©

    // Í∞úÎ∞ú Î™®ÎìúÏóêÏÑú ÏÑ±Îä• ÏöîÏïΩ ÌëúÏãú
    if (process.env.NODE_ENV === 'development') {
      showPerformanceSummary()
    }
  }, [])

  // Ïª¥Ìè¨ÎÑåÌä∏Îäî ÏãúÍ∞ÅÏ†Å ÏöîÏÜå ÏóÜÏùå (Î™®ÎãàÌÑ∞ÎßÅÎßå)
  return null
}

// ÏÑ±Îä• Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑º Ìó¨Ìçº Ìï®ÏàòÎì§
export const webVitalsUtils = {
  // Ï†ÄÏû•Îêú ÏÑ±Îä• Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
  getStoredVitals: (): WebVitalsData[] => {
    if (typeof window === 'undefined') return []
    try {
      return JSON.parse(localStorage.getItem('web-vitals') || '[]')
    } catch {
      return []
    }
  },

  // ÏÑ±Îä• Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
  clearStoredVitals: (): void => {
    if (typeof window !== 'undefined') {
      localStorage.removeItem('web-vitals')
    }
  },

  // ÌèâÍ∑† ÏÑ±Îä• Í≥ÑÏÇ∞
  getAverageVitals: (): Record<string, number> => {
    const vitals = webVitalsUtils.getStoredVitals()
    const grouped = vitals.reduce(
      (acc, vital) => {
        if (!acc[vital.name]) acc[vital.name] = []
        acc[vital.name].push(vital.value)
        return acc
      },
      {} as Record<string, number[]>
    )

    return Object.entries(grouped).reduce(
      (acc, [name, values]) => {
        acc[name] = values.reduce((sum, val) => sum + val, 0) / values.length
        return acc
      },
      {} as Record<string, number>
    )
  },

  // ÏÑ±Îä• Îì±Í∏â Î∂ÑÌè¨ Í≥ÑÏÇ∞
  getVitalsDistribution: (): Record<string, Record<string, number>> => {
    const vitals = webVitalsUtils.getStoredVitals()
    const distribution = {} as Record<string, Record<string, number>>

    vitals.forEach(vital => {
      if (!distribution[vital.name]) {
        distribution[vital.name] = { good: 0, 'needs-improvement': 0, poor: 0 }
      }
      distribution[vital.name][vital.rating]++
    })

    return distribution
  },
}

export default WebVitalsReporter
